#ifndef hmac_sha256_h
#define hmac_sha256_h

#include "hmac_sha256.h"

void hmac_sha256(u8 hash[32], slice key, slice message) {

    slice inner_pad = slice_literal(
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36
    );

    slice outer_pad = slice_literal(
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
        0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c
    );

    size_t hmac_key_length = 0;
    u8 hmac_key[64];
    if (key.length > 64) {
        hmac_key_length = 32;
        sha256(hmac_key, key);
    }
    else {
        for (; hmac_key_length < key.length; hmac_key_length += 1) {
            hmac_key[hmac_key_length] = key.items[hmac_key_length];
        }
    }

    for (; hmac_key_length < 64; hmac_key_length += 1) {
        hmac_key[hmac_key_length] = 0;
    }

    for (size_t i = 0; i < 64; i += 1) {
        inner_pad.items[i] ^= hmac_key[i];
        outer_pad.items[i] ^= hmac_key[i];
    }

    sha256_ctx ctx = sha256_begin();
    ctx = sha256_run(ctx, inner_pad);
    ctx = sha256_run(ctx, message);
    u8 inner_hash[32];
    sha256_end(ctx, inner_hash);
    ctx = sha256_begin();
    ctx = sha256_run(ctx, outer_pad);
    ctx = sha256_run(
        ctx, 
        (slice) slice_make(32, 32, inner_hash)
    );
    sha256_end(ctx, hash);
}

void hmac_sha256_string(u8 hash[32], slice key, char* message) {
    hmac_sha256(
        hash,
        key,
        string_to_slice(message)
    );
}

hmac_sha256_ctx hmac_sha256_begin(slice key) {

    hmac_sha256_ctx ctx = {
        .outer_pad = {
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c,
            0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c, 0x5c
        }
    };

    slice inner_pad = slice_literal(
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36
    );

    size_t hmac_key_length = 0;
    u8 hmac_key[64];
    if (key.length > 64) {
        hmac_key_length = 32;
        sha256(hmac_key, key);
    }
    else {
        for (; hmac_key_length < key.length; hmac_key_length += 1) {
            hmac_key[hmac_key_length] = key.items[hmac_key_length];
        }
    }

    for (; hmac_key_length < 64; hmac_key_length += 1) {
        hmac_key[hmac_key_length] = 0;
    }

    for (size_t i = 0; i < 64; i += 1) {
        inner_pad.items[i] ^= hmac_key[i];
        ctx.outer_pad[i] ^= hmac_key[i];
    }

    ctx.hash_ctx = sha256_begin();
    ctx.hash_ctx = sha256_run(ctx.hash_ctx, inner_pad);

    return ctx;
}

hmac_sha256_ctx hmac_sha256_run(hmac_sha256_ctx ctx, slice message) {
    ctx.hash_ctx = sha256_run(ctx.hash_ctx, message);
    return ctx;
}

void hmac_sha256_end(hmac_sha256_ctx ctx, u8 hash[32]) {
    u8 inner_hash[32];
    sha256_end(ctx.hash_ctx, inner_hash);
    ctx.hash_ctx = sha256_begin();
    ctx.hash_ctx = sha256_run(
        ctx.hash_ctx, 
        (slice) slice_make(64, 64, ctx.outer_pad)
    );
    ctx.hash_ctx = sha256_run(
        ctx.hash_ctx, 
        (slice) slice_make(32, 32, inner_hash)
    );
    sha256_end(ctx.hash_ctx, hash);
}

#endif
